<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - Rede de Atendimento</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos para tela de login */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000000 0%, #25020F 50%, #000000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: linear-gradient(135deg, #25020F 0%, #9E1E4C 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(158, 30, 76, 0.3);
            border: 1px solid #FF1168;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header h1 {
            color: #ECECEC;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #8F8F8F;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #9E1E4C;
            border-radius: 8px;
            font-size: 1rem;
            background: #25020F;
            color: #ECECEC;
        }

        .login-form input:focus {
            outline: none;
            border-color: #FF1168;
            box-shadow: 0 0 0 3px rgba(255, 17, 104, 0.2);
        }

        .login-form input::placeholder {
            color: #8F8F8F;
        }

        .login-btn {
            background: #FF1168;
            color: #ECECEC;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover:not(:disabled) {
            background: #9E1E4C;
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            background: #8F8F8F;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(255, 17, 104, 0.2);
            color: #FF1168;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #FF1168;
            margin-top: 15px;
            display: none;
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #9E1E4C;
            color: #ECECEC;
            border: 2px solid #FF1168;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .logout-btn:hover {
            background: #FF1168;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-lock" style="font-size: 3rem; color: #FF1168; margin-bottom: 15px;"></i>
                <h1>Área Administrativa</h1>
                <p>Faça login para acessar</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <input type="email" id="email" placeholder="Digite seu email" required>
                <input type="password" id="password" placeholder="Digite sua senha" required>
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Botão de Logout (oculto inicialmente) -->
    <button id="logoutBtn" class="logout-btn" style="display: none;">
        <i class="fas fa-sign-out-alt"></i> Sair
    </button>

    <!-- Conteúdo Admin Original (oculto inicialmente) -->
    <div id="adminContent" class="admin-content">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <i class="fas fa-cog"></i>
                    <h1>Administração - Rede de Atendimento</h1>
                </div>
                <nav class="admin-nav">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-search"></i>
                        Voltar para Pesquisa
                    </a>
                </nav>
            </header>

            <main class="main-content">
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="manual">Cadastro Manual</button>
                    <button class="tab-btn" data-tab="upload">Upload de Planilha</button>
                    <button class="tab-btn" data-tab="view">Visualizar Dados</button>
                </div>

                <!-- Tab Cadastro Manual -->
                <div id="manual" class="tab-content active">
                    <div class="form-section">
                        <h2>Cadastro Manual</h2>
                        <form id="manualForm" class="admin-form">
                            <!-- Seu formulário HTML (sem alterações) -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nome">Nome do Hospital/Clínica *</label>
                                    <input type="text" id="nome" name="nome" required>
                                </div>
                                <div class="form-group">
                                    <label for="estado">Estado *</label>
                                    <select id="estado" name="estado" required>
                                        <option value="">Selecione o estado</option>
                                        <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amapá</option><option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Ceará</option><option value="DF">Distrito Federal</option><option value="ES">Espírito Santo</option><option value="GO">Goiás</option><option value="MA">Maranhão</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option><option value="MG">Minas Gerais</option><option value="PA">Pará</option><option value="PB">Paraíba</option><option value="PR">Paraná</option><option value="PE">Pernambuco</option><option value="PI">Piauí</option><option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option><option value="RO">Rondônia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option><option value="SP">São Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cidade">Cidade *</label>
                                    <input type="text" id="cidade" name="cidade" required>
                                </div>
                                <div class="form-group">
                                    <label for="tipo">Tipo *</label>
                                    <select id="tipo" name="tipo" required>
                                        <option value="">Selecione o tipo</option>
                                        <option value="hospital">Hospital</option>
                                        <option value="laboratorio">Laboratório</option>
                                        <option value="clinica">Clínica</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Operadoras *</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item operadora-checkbox"><input type="checkbox" name="operadoras" value="amil"><span class="checkmark amil"></span><span class="operadora-label">Amil Padrão</span></label>
                                    <label class="checkbox-item operadora-checkbox"><input type="checkbox" name="operadoras" value="amil-selecionada"><span class="checkmark amil-selecionada"></span><span class="operadora-label">Amil Selecionada</span></label>
                                    <label class="checkbox-item operadora-checkbox"><input type="checkbox" name="operadoras" value="bradesco"><span class="checkmark bradesco"></span><span class="operadora-label">Bradesco</span></label>
                                    <label class="checkbox-item operadora-checkbox"><input type="checkbox" name="operadoras" value="sulamerica"><span class="checkmark sulamerica"></span><span class="operadora-label">Sul América</span></label>
                                    <label class="checkbox-item operadora-checkbox"><input type="checkbox" name="operadoras" value="hapvida"><span class="checkmark hapvida"></span><span class="operadora-label">Hapvida</span></label>
                                    <label class="checkbox-item operadora-checkbox"><input type="checkbox" name="operadoras" value="liv-saude"><span class="checkmark liv-saude"></span><span class="operadora-label">Liv Saúde</span></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="modalidades">Modalidades de Atendimento</label>
                                <textarea id="modalidades" name="modalidades" placeholder="Ex: Pronto Atendimento, Maternidade, UTI..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="planos">Modelos de Plano</label>
                                <textarea id="planos" name="planos" placeholder="Descreva os modelos de plano (opcional)"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Cadastro</button>
                                <button type="reset" class="btn btn-secondary"><i class="fas fa-undo"></i> Limpar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tab Upload de Planilha -->
                <div id="upload" class="tab-content">
                    <div class="upload-section">
                        <h2>Upload de Planilha Excel</h2>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <i class="fas fa-file-excel"></i>
                                <h3>Arraste sua planilha aqui</h3>
                                <p>ou clique para selecionar</p>
                                <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
                                <button type="button" class="btn btn-outline" onclick="document.getElementById('fileInput').click()">Selecionar Arquivo</button>
                            </div>
                        </div>
                        <div id="uploadPreview" class="upload-preview hidden">
                            <h4>Prévia dos Dados:</h4>
                            <div id="previewTableContainer"></div>
                            <div class="upload-actions">
                                <button id="confirmUpload" class="btn btn-primary"><i class="fas fa-upload"></i> Confirmar Upload</button>
                                <button id="cancelUpload" class="btn btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Visualizar Dados -->
                <div id="view" class="tab-content">
                    <div class="view-section">
                        <h2>Visualizar Dados Cadastrados</h2>
                        <div class="view-controls">
                            <div class="search-controls">
                                <input type="text" id="viewSearch" placeholder="Buscar por nome, cidade ou estado...">
                                <select id="viewFilter">
                                    <option value="">Todas as operadoras</option>
                                    <option value="amil">Amil Padrão</option>
                                    <option value="amil-selecionada">Amil Selecionada</option>
                                    <option value="bradesco">Bradesco</option>
                                    <option value="sulamerica">Sul América</option>
                                    <option value="hapvida">Hapvida</option>
                                    <option value="liv-saude">Liv Saúde</option>
                                </select>
                            </div>
                        </div>
                        <div id="dataTable" class="data-table">
                            <!-- Tabela de dados será inserida aqui -->
                        </div>
                    </div>
                </div>
            </main>
            <footer class="footer">
                <p>&copy; 2025 Rede de Atendimento. Área Administrativa.</p>
            </footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLjxxFLwx9VU23VyYpjsVjcdVB98Pzls4",
            authDomain: "rede-atendimento-planos.firebaseapp.com",
            projectId: "rede-atendimento-planos",
            storageBucket: "rede-atendimento-planos.appspot.com",
            messagingSenderId: "805398823851",
            appId: "1:805398823851:web:c8edb87faa4483490688ee"
        };

        // Função para normalizar strings para comparação
function normalizarString(str) {
    if (!str) return '';
    return str.toString()
        .toLowerCase()
        .trim()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/[^\w\s]/g, '') // Remove caracteres especiais
        .replace(/\s+/g, ' '); // Normaliza espaços
}

// Função para verificar se dois registros são duplicatas
function saoRegistrosDuplicados(registro1, registro2) {
    const nome1 = normalizarString(registro1.nome);
    const cidade1 = normalizarString(registro1.cidade);
    const estado1 = normalizarString(registro1.estado);
    
    const nome2 = normalizarString(registro2.nome);
    const cidade2 = normalizarString(registro2.cidade);
    const estado2 = normalizarString(registro2.estado);
    
    return nome1 === nome2 && cidade1 === cidade2 && estado1 === estado2;
}

// Função para verificar duplicatas na base existente
async function verificarDuplicatasExistentes(novoRegistro) {
    try {
        const snapshot = await db.collection('hospitais').get();
        const duplicatasEncontradas = [];
        
        snapshot.docs.forEach(doc => {
            const registroExistente = { id: doc.id, ...doc.data() };
            if (saoRegistrosDuplicados(novoRegistro, registroExistente)) {
                duplicatasEncontradas.push(registroExistente);
            }
        });
        
        return duplicatasEncontradas;
    } catch (error) {
        console.error('Erro ao verificar duplicatas:', error);
        throw error;
    }
}

// Função para verificar duplicatas internas em array
function verificarDuplicatasInternas(registros) {
    const duplicatasInternas = [];
    const registrosUnicos = [];
    
    for (let i = 0; i < registros.length; i++) {
        let ehDuplicata = false;
        
        for (let j = 0; j < registrosUnicos.length; j++) {
            if (saoRegistrosDuplicados(registros[i], registrosUnicos[j])) {
                duplicatasInternas.push({
                    registro: registros[i],
                    posicao: i + 1,
                    duplicataDe: j + 1
                });
                ehDuplicata = true;
                break;
            }
        }
        
        if (!ehDuplicata) {
            registrosUnicos.push(registros[i]);
        }
    }
    
    return { duplicatasInternas, registrosUnicos };
}

// Função para criar modal de duplicatas
function criarModalDuplicatas(duplicatas, callback) {
    const modalHTML = `
        <div id="duplicateModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        ">
            <div style="
                background: linear-gradient(135deg, #25020F 0%, #9E1E4C 100%);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(158, 30, 76, 0.5);
                border: 2px solid #FF1168;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                color: #ECECEC;
            ">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: #FF1168; font-size: 2rem;"></i>
                    <h2 style="margin: 0; color: #ECECEC;">Duplicatas Encontradas</h2>
                </div>
                
                <p style="color: #8F8F8F; margin-bottom: 20px;">
                    Foram encontrados registros que podem ser duplicatas. Revise antes de continuar:
                </p>
                
                <div style="
                    background: rgba(37, 2, 15, 0.8);
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 20px;
                    border: 1px solid #9E1E4C;
                    max-height: 300px;
                    overflow-y: auto;
                ">
                    ${duplicatas.map((dup, index) => `
                        <div style="
                            padding: 15px;
                            border-bottom: 1px solid #9E1E4C;
                            margin-bottom: 10px;
                        ">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-copy" style="color: #FF1168;"></i>
                                <strong style="color: #FF1168;">Duplicata ${index + 1}</strong>
                            </div>
                            <div style="color: #ECECEC; margin-bottom: 5px;">
                                <strong>Novo:</strong> ${dup.novoRegistro.nome} - ${dup.novoRegistro.cidade}, ${dup.novoRegistro.estado}
                            </div>
                            <div style="color: #8F8F8F;">
                                <strong>Existente:</strong> ${dup.registroExistente.nome} - ${dup.registroExistente.cidade}, ${dup.registroExistente.estado}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button id="cancelarDuplicata" style="
                        background: #8F8F8F;
                        color: #ECECEC;
                        border: 2px solid #8F8F8F;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: all 0.3s ease;
                    ">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button id="prosseguirDuplicata" style="
                        background: #FF1168;
                        color: #ECECEC;
                        border: 2px solid #FF1168;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: all 0.3s ease;
                    ">
                        <i class="fas fa-check"></i> Prosseguir Mesmo Assim
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const modal = document.getElementById('duplicateModal');
    const cancelarBtn = document.getElementById('cancelarDuplicata');
    const prosseguirBtn = document.getElementById('prosseguirDuplicata');
    
    cancelarBtn.addEventListener('click', () => {
        modal.remove();
        callback(false);
    });
    
    prosseguirBtn.addEventListener('click', () => {
        modal.remove();
        callback(true);
    });
}

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Elementos DOM
        const loginOverlay = document.getElementById('loginOverlay');
        const adminContent = document.getElementById('adminContent');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('errorMessage');

        // Verificar autenticação
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Usuário logado - mostrar conteúdo admin
                loginOverlay.style.display = 'none';
                adminContent.classList.add('active');
                logoutBtn.style.display = 'block';
                
                // Inicializar scripts admin após login bem-sucedido
                inicializarAdmin();
            } else {
                // Usuário não logado - mostrar login
                loginOverlay.style.display = 'flex';
                adminContent.classList.remove('active');
                logoutBtn.style.display = 'none';
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            errorMessage.style.display = 'none';

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                let errorMsg = 'Erro desconhecido';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMsg = 'Usuário não encontrado';
                        break;
                    case 'auth/wrong-password':
                        errorMsg = 'Senha incorreta';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'Email inválido';
                        break;
                    default:
                        errorMsg = error.message;
                }
                
                errorMessage.textContent = errorMsg;
                errorMessage.style.display = 'block';
                document.getElementById('password').value = '';
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            if (confirm('Tem certeza que deseja sair?')) {
                try {
                    await auth.signOut();
                } catch (error) {
                    alert('Erro ao fazer logout');
                }
            }
        });

        // Função para inicializar admin (código completo)
        function inicializarAdmin() {
            // --- VARIÁVEIS GLOBAIS ---
            const hospitaisCollection = db.collection('hospitais');
            let dadosHospitais = [];
            let dadosUpload = [];

            // --- ELEMENTOS DO DOM ---
            const confirmUploadBtn = document.getElementById('confirmUpload');
            const cancelUploadBtn = document.getElementById('cancelUpload');
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const uploadPreview = document.getElementById('uploadPreview');
            const previewTableContainer = document.getElementById('previewTableContainer');
            const manualForm = document.getElementById('manualForm');
            const dataTable = document.getElementById('dataTable');
            const viewSearch = document.getElementById('viewSearch');
            const viewFilter = document.getElementById('viewFilter');

            // --- SISTEMA DE ABAS ---
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            function switchTab(targetTab) {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
                const activeContent = document.getElementById(targetTab);
                
                if (activeButton && activeContent) {
                    activeButton.classList.add('active');
                    activeContent.classList.add('active');
                    
                    if (targetTab === 'view') {
                        carregarTabelaDados();
                    }
                }
            }

            // Event listeners para as abas
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });

            // --- CARREGAMENTO INICIAL DOS DADOS ---
            function carregarDadosIniciais() {
                console.log('Carregando dados iniciais...');
                hospitaisCollection.get().then(snapshot => {
                    dadosHospitais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`${dadosHospitais.length} registros carregados com sucesso!`);
                }).catch(error => {
                    console.error("Erro ao carregar dados iniciais: ", error);
                });
            }

            // --- FORMULÁRIO MANUAL ---
        if (manualForm) {
            manualForm.addEventListener('submit', async (e) => {
            e.preventDefault();
        
            const formData = new FormData(manualForm);
            const operadoras = [];
        
            formData.getAll('operadoras').forEach(op => {
            if (op) operadoras.push(op);
        });
        
        if (operadoras.length === 0) {
            alert('Selecione ao menos uma operadora.');
            return;
        }
        
        const novoHospital = {
            nome: formData.get('nome').trim(),
            estado: formData.get('estado'),
            cidade: formData.get('cidade').trim(),
            tipo: formData.get('tipo'),
            operadoras: operadoras,
            modalidades: formData.get('modalidades')?.trim() || '',
            planos: formData.get('planos')?.trim() || ''
        };
        
        if (!novoHospital.nome || !novoHospital.estado || !novoHospital.cidade || !novoHospital.tipo) {
            alert('Preencha todos os campos obrigatórios.');
            return;
        }
        
        try {
            // *** VERIFICAÇÃO DE DUPLICATAS ***
            const duplicatas = await verificarDuplicatasExistentes(novoHospital);
            
            if (duplicatas.length > 0) {
                const duplicatasFormatadas = duplicatas.map(dup => ({
                    novoRegistro: novoHospital,
                    registroExistente: dup
                }));
                
                criarModalDuplicatas(duplicatasFormatadas, async (prosseguir) => {
                    if (prosseguir) {
                        await salvarRegistro(novoHospital);
                    }
                });
            } else {
                await salvarRegistro(novoHospital);
            }
        } catch (error) {
            console.error("Erro na verificação:", error);
            alert('Erro ao verificar duplicatas. Verifique o console.');
        }
    });
    
    // Função auxiliar para salvar registro
    async function salvarRegistro(registro) {
        try {
            await hospitaisCollection.add(registro);
            alert('Cadastro realizado com sucesso!');
            manualForm.reset();
            carregarDadosIniciais();
        } catch (error) {
            console.error("Erro ao salvar:", error);
            alert('Erro ao salvar os dados.');
        }
    }
}

            // --- LÓGICA DE UPLOAD DE PLANILHA ---
            function processarDadosPlanilha(jsonData) {
    let dadosProcessados = jsonData.map(row => {
        let operadoras = [];
        if (row.Operadoras) {
            operadoras = row.Operadoras.toString()
                .split(',')
                .map(op => op.trim().toLowerCase())
                .filter(Boolean);
        }
        
        return {
            nome: (row.Nome || '').toString().trim(),
            estado: (row.Estado || '').toString().trim(),
            cidade: (row.Cidade || '').toString().trim(),
            tipo: (row.Tipo || 'hospital').toString().toLowerCase(),
            operadoras: operadoras,
            modalidades: (row.Modalidades || '').toString().trim(),
            planos: (row.Planos || '').toString().trim()
        };
    }).filter(item => item.nome && item.estado && item.cidade);
    
    if (dadosProcessados.length === 0) {
        alert('Nenhum dado válido encontrado na planilha.');
        return;
    }
    
    // *** VERIFICAÇÃO DE DUPLICATAS INTERNAS ***
    const { duplicatasInternas, registrosUnicos } = verificarDuplicatasInternas(dadosProcessados);
    
    dadosUpload = registrosUnicos;
    
    let relatorioHTML = '';
    if (duplicatasInternas.length > 0) {
        relatorioHTML = `
            <div style="
                background: rgba(255, 17, 104, 0.1);
                border: 1px solid #FF1168;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                color: #ECECEC;
            ">
                <h4 style="color: #FF1168; margin-bottom: 10px;">
                    <i class="fas fa-broom"></i> Limpeza Automática Realizada
                </h4>
                <p style="margin: 5px 0;">• Registros na planilha: ${jsonData.length}</p>
                <p style="margin: 5px 0;">• Duplicatas internas removidas: ${duplicatasInternas.length}</p>
                <p style="margin: 5px 0;">• Registros únicos processados: ${registrosUnicos.length}</p>
            </div>
        `;
    }
    
    const previewHTML = relatorioHTML + `
        <div style="padding: 20px; background: rgba(37, 2, 15, 0.8); border-radius: 10px;">
            <p style="color: #FF1168; font-weight: bold; margin-bottom: 15px;">
                ${registrosUnicos.length} registros prontos para upload
            </p>
            <ul style="color: #8F8F8F; list-style: none; padding: 0;">
                ${registrosUnicos.slice(0, 5).map(item => 
                    `<li style="padding: 8px; border-bottom: 1px solid #9E1E4C; margin-bottom: 5px;">
                        <strong style="color: #ECECEC;">${item.nome}</strong><br>
                        <small>${item.cidade}, ${item.estado}</small>
                    </li>`
                ).join('')}
            </ul>
            ${registrosUnicos.length > 5 ? `<p style="color: #8F8F8F; font-style: italic;">... e mais ${registrosUnicos.length - 5} registros</p>` : ''}
        </div>
    `;
    
    previewTableContainer.innerHTML = previewHTML;
    uploadPreview.classList.remove('hidden');
}

            // --- TABELA DE VISUALIZAÇÃO ---
            function carregarTabelaDados() {
                if (!dataTable) return;
                
                hospitaisCollection.get().then(snapshot => {
                    const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (dados.length === 0) {
                        dataTable.innerHTML = '<div style="padding: 40px; text-align: center; color: #8F8F8F;">Nenhum registro encontrado.</div>';
                        return;
                    }

                    const tableHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(158, 30, 76, 0.3);">
                                    <th style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #ECECEC;">Nome</th>
                                    <th style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #ECECEC;">Localização</th>
                                    <th style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #ECECEC;">Tipo</th>
                                    <th style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #ECECEC;">Operadoras</th>
                                    <th style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #ECECEC;">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dados.map(item => `
                                    <tr style="transition: background 0.3s ease;" onmouseover="this.style.background='rgba(255, 17, 104, 0.1)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #ECECEC;">${item.nome}</td>
                                        <td style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #8F8F8F;">${item.cidade}, ${item.estado}</td>
                                        <td style="padding: 15px; border-bottom: 1px solid #9E1E4C; color: #8F8F8F;">${item.tipo}</td>
                                        <td style="padding: 15px; border-bottom: 1px solid #9E1E4C;">
                                            ${(item.operadoras || []).map(op => 
                                                `<span style="background: #9E1E4C; color: #ECECEC; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px;">${getOperadoraNome(op)}</span>`
                                            ).join('')}
                                        </td>
                                        <td style="padding: 15px; border-bottom: 1px solid #9E1E4C;">
                                            <button onclick="excluirItem('${item.id}')" style="background: #9E1E4C; color: #ECECEC; border: 1px solid #FF1168; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
                                                <i class="fas fa-trash"></i> Excluir
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    dataTable.innerHTML = tableHTML;
                    
                }).catch(error => {
                    console.error("Erro ao carregar dados da tabela:", error);
                    dataTable.innerHTML = '<div style="padding: 40px; text-align: center; color: #FF1168;">Erro ao carregar dados.</div>';
                });
            }

            // Função auxiliar
            function getOperadoraNome(op) {
                const nomes = {
                    'amil': 'Amil',
                    'amil-selecionada': 'Amil Selecionada',
                    'bradesco': 'Bradesco',
                    'sulamerica': 'Sul América',
                    'hapvida': 'Hapvida',
                    'liv-saude': 'Liv Saúde'
                };
                return nomes[op] || op;
            }

            // Função global para excluir
            window.excluirItem = function(id) {
                if (confirm('Tem certeza que deseja excluir este item?')) {
                    hospitaisCollection.doc(id).delete().then(() => {
                        alert('Item excluído com sucesso!');
                        carregarTabelaDados();
                        carregarDadosIniciais();
                    }).catch(error => {
                        console.error("Erro ao excluir:", error);
                        alert('Erro ao excluir o item.');
                    });
                }
            };

            // --- EVENT LISTENERS ---
            
            // Upload de arquivo
            if (fileInput) {
                fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            }

            // Drag and drop
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        handleFile(e.dataTransfer.files[0]);
                    }
                });
            }

            // Botão cancelar upload
            if (cancelUploadBtn) {
                cancelUploadBtn.addEventListener('click', () => {
                    uploadPreview.classList.add('hidden');
                    if (fileInput) fileInput.value = '';
                    dadosUpload = [];
                });
            }

            // Botão confirmar upload
            if (confirmUploadBtn) {
    confirmUploadBtn.addEventListener('click', async () => {
        if (dadosUpload.length === 0) {
            alert("Não há dados para enviar.");
            return;
        }

        confirmUploadBtn.disabled = true;
        confirmUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando duplicatas...';

        try {
            // *** VERIFICAÇÃO DE DUPLICATAS COM BASE EXISTENTE ***
            const duplicatasExistentes = [];
            
            for (const registro of dadosUpload) {
                const duplicatas = await verificarDuplicatasExistentes(registro);
                if (duplicatas.length > 0) {
                    duplicatas.forEach(dup => {
                        duplicatasExistentes.push({
                            novoRegistro: registro,
                            registroExistente: dup
                        });
                    });
                }
            }
            
            if (duplicatasExistentes.length > 0) {
                confirmUploadBtn.innerHTML = '<i class="fas fa-upload"></i> Confirmar Upload';
                confirmUploadBtn.disabled = false;
                
                criarModalDuplicatas(duplicatasExistentes, async (prosseguir) => {
                    if (prosseguir) {
                        await realizarUpload();
                    }
                });
            } else {
                await realizarUpload();
            }
        } catch (error) {
            console.error("Erro na verificação:", error);
            alert("Erro ao verificar duplicatas: " + error.message);
            confirmUploadBtn.disabled = false;
            confirmUploadBtn.innerHTML = '<i class="fas fa-upload"></i> Confirmar Upload';
        }
    });
    
    // Função auxiliar para realizar o upload
    async function realizarUpload() {
        confirmUploadBtn.disabled = true;
        confirmUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        try {
            const batch = db.batch();
            dadosUpload.forEach(item => {
                const docRef = hospitaisCollection.doc();
                batch.set(docRef, item);
            });

            await batch.commit();
            alert(`${dadosUpload.length} registros importados com sucesso!`);
            cancelUploadBtn.click();
            carregarDadosIniciais();
        } catch (error) {
            console.error("Erro no upload:", error);
            alert("Erro ao enviar os dados: " + error.message);
        } finally {
            confirmUploadBtn.disabled = false;
            confirmUploadBtn.innerHTML = '<i class="fas fa-upload"></i> Confirmar Upload';
        }
    }
}

            // Busca na visualização
            if (viewSearch) {
                viewSearch.addEventListener('input', carregarTabelaDados);
            }
            
            if (viewFilter) {
                viewFilter.addEventListener('change', carregarTabelaDados);
            }

            // --- INICIALIZAÇÃO ---
            carregarDadosIniciais();
            console.log('Admin inicializado com sucesso!');
        }
    </script>
</body>
</html>
